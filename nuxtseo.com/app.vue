<script setup lang="ts">
import { useModuleList } from '~/utils/data'

const { data: navigation } = await useAsyncData('navigation', () => fetchContentNavigation())

const route = useRoute()
const publicRuntimeConfig = useRuntimeConfig().public
const segment = computed(() => route.path.split('/')[1])
const children = computed(() => {
  console.log('finding children for segment', segment.value, navigation!.value!.filter(i => i._path === `/${segment.value}`))
  return navigation!.value!.find(i => i._path === `/${segment.value}`)?.children || []
})

provide('navigation', navigation)
provide('docsAsideLinks', children)
provide('module', computed(() => {
  const m = useModuleList().find(l => l?.slug === segment.value)
  const stats = (publicRuntimeConfig.moduleStats || []).find(m2 => m2.id === m?.id)?.stats || {}
  if (stats?.downloads) {
    // will look like 395493, we need to make it human readible using native APIs
    // we want to display it like 395k
    m.downloads = Number(stats.downloads).toLocaleString('en-US', { notation: 'compact', compactDisplay: 'short' })
  }
  if (stats?.stars)
    m.stars = stats.stars

  return m
}))

const modules = useModuleList()

useSeoMeta({
  ogTitle: 'Nuxt SEO · All the boring SEO work for Nuxt done.',
  // twitterTitle: 'Nuxt SEO - All the boring SEO work for Nuxt done.',
})
</script>

<template>
  <div>
    <Header />

    <div>
      <NuxtPage />
    </div>

    <ClientOnly>
      <DocsSearch />
    </ClientOnly>

    <footer class="relative z-10 antialiased font-sans bg-white dark:bg-gray-900 text-sm text-gray-700 dark:text-gray-200 mt-20">
      <div class="border-t border-gray-200 dark:border-gray-800">
        <UContainer>
          <div class="py-10 grid xl:grid-cols-3 lg:gap-20 gap-10">
            <div>
              <div class="mb-5">
                <NuxtLink to="/" title="Home" class="flex items-end gap-1.5 font-bold text-xl text-gray-900 dark:text-white font-title">
                  <Logo />
                </NuxtLink>
              </div>
              <nav>
                <ul class="space-y-6">
                  <li>
                    <NuxtLink to="/nuxt-seo/getting-started/what-is-nuxt-seo">
                      What is Nuxt SEO?
                    </NuxtLink>
                  </li>
                  <li>
                    <NuxtLink to="/nuxt-seo/getting-started/installation">
                      Install Nuxt SEO
                    </NuxtLink>
                  </li>
                </ul>
              </nav>
            </div>
            <div>
              <h3 class="font-bold mb-5">
                Modules
              </h3>
              <nav>
                <ul class="grid grid-cols-2 gap-6">
                  <li v-for="(module, key) in modules" :key="key">
                    <NuxtLink :to="module.to">
                      <UIcon dynamic :name="module.icon" />
                      {{ module.label }}
                    </NuxtLink>
                  </li>
                </ul>
              </nav>
            </div>
            <div>
              <div class="bg-gray-50 dark:bg-gray-800 flex rounded-xl shadow p-5">
                <div>
                  <div class="mb-2">
                    Hey <UIcon name="i-noto-waving-hand" /> My name is <a href="https://harlanzw.com" target="_blank" class="underline">Harlan</a> and I'm the author and maintainer of Nuxt SEO.
                  </div>
                  <div>
                    I'd love to have your <a href="https://github.com/sponsors/harlan-zw" class="underline">support</a>!
                  </div>
                </div>
                <div class="gap-3">
                  <img alt="Harlan Wilton" loading="lazy" src="https://avatars.githubusercontent.com/u/5326365?v=4" class="mx-auto rounded-full w-10 h-10 mb-3">
                  <div class="flex justify-center items-center opacity-70">
                    <UButton color="white" title="Twitter" variant="ghost" to="https://twitter.com/harlan_zw" target="_blank">
                      <UIcon name="i-logos-twitter" class="text-xl" />
                    </UButton>
                    <UButton color="white" title="GitHub" aria-label="GitHub" variant="ghost" to="https://github.com/harlan-zw" target="_blank">
                      <UIcon name="i-logos-github-icon" class="text-xl" />
                    </UButton>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </UContainer>
      </div>
      <div class="border-t border-gray-200 dark:border-gray-800">
        <UContainer>
          <div class="py-10">
            Copyright © 2023-{{ new Date().getFullYear() }} Harlan Wilton - <a href="https://github.com/harlan-zw/nuxt-seo/blob/main/LICENSE">MIT License</a>
          </div>
        </UContainer>
      </div>
    </footer>
    <NuxtLoadingIndicator />
  </div>
</template>
